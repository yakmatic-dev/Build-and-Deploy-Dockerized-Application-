name: Build and Deploy Dockerized JAR - PetClinic.
on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      image_tag: ${{ steps.set_tag.outputs.image_tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'microsoft'
      
      - name: Build with Maven
        run: mvn clean package -DskipTests
      
      - name: Set Docker image tag
        id: set_tag
        run: |
          SANITIZED_BRANCH=$(echo "${GITHUB_REF_NAME}" | tr '/' '-')
          IMAGE_TAG="${SANITIZED_BRANCH}-${GITHUB_SHA::8}"
          echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_ENV
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
      
      - name: Build Docker image
        run: docker build -t spring-petclinic:${{ env.IMAGE_TAG }} .
      
      - name: Save Docker image as artifact
        run: docker save spring-petclinic:${{ env.IMAGE_TAG }} -o spring-petclinic.tar
      
      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: spring-petclinic.tar

  deploy:
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: Production
    permissions:
      contents: read
    steps:
      - name: Download Docker image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image
      
      - name: Copy Docker image to server
        uses: appleboy/scp-action@v0.1.5
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ secrets.SERVER_PORT }}
          source: "spring-petclinic.tar"
          target: ${{ secrets.SERVER_DEPLOY_PATH }}
      
      - name: Load and run Docker container on server
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            cd ${{ secrets.SERVER_DEPLOY_PATH }}
            IMAGE_TAG="${{ needs.build.outputs.image_tag }}"
            docker load -i spring-petclinic.tar
            docker rm -f spring-petclinic || true
            docker run -d --name spring-petclinic -p 8080:8080 spring-petclinic:${IMAGE_TAG}
